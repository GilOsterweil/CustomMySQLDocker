name: Build and Publish Custom Images

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build MySQL image
        run: |
          docker build -t ghcr.io/gilosterweil/custom-mysql/mysql:latest ./mysql

      - name: Push MySQL image
        run: |
          docker push ghcr.io/gilosterweil/custom-mysql/mysql:latest

      - name: Build CloudBeaver image
        run: |
          docker build -t ghcr.io/gilosterweil/custom-mysql/cloudbeaver:latest ./cloudbeaver

      - name: Push CloudBeaver image
        run: |
          docker push ghcr.io/gilosterweil/custom-mysql/cloudbeaver:latest

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Playwright
        run: |
          npm init -y
          npm install @playwright/test
          npx playwright install --with-deps

      - name: Start CloudBeaver container
        run: |
          docker run -d --name cloudbeaver-test \
            -p 8978:8978 \
            ghcr.io/gilosterweil/custom-mysql/cloudbeaver:latest

      - name: Wait for CloudBeaver Port
        timeout-minutes: 2
        run: |
          echo "Waiting for CloudBeaver port 8978..."
          for i in {1..40}; do
            if curl -s http://localhost:8978 >/dev/null; then
              echo "CloudBeaver port is open!"
              break
            fi
            echo "Waiting..."
            sleep 3
          done

      - name: Run Playwright snapshot test
        run: |
          cat > test.test.js << 'EOF'
          const { test, expect } = require("@playwright/test");

          test("CloudBeaver shows MySQL connection", async ({ page }) => {
            // 1. Set a hard limit for the test
            test.setTimeout(120000);

            try {
              console.log("Navigating to CloudBeaver...");
              // We set a shorter timeout for goto (60s) so we have time left for the finally block
              await page.goto("http://localhost:8978", { waitUntil: 'networkidle', timeout: 60000 });
              
              console.log("Page loaded, waiting for UI...");

              // 2. Wait for the main app wrapper
              await page.waitForSelector('div[class*="Application"]', { timeout: 30000 });
              
            } catch (error) {
              console.log("Test Logic Failed (taking screenshot anyway):", error.message);
            } finally {
              // 3. This runs absolutely always - success or failure
              console.log("Taking screenshot...");
              await page.screenshot({ path: "cloudbeaver_snapshot.png", fullPage: true });
            }
          });
          EOF

          # Run the test
          npx playwright test test.test.js

      - name: Upload snapshot artifact
        if: always() # Upload even if test fails
        uses: actions/upload-artifact@v4
        with:
          name: cloudbeaver-snapshot
          path: cloudbeaver_snapshot.png
          